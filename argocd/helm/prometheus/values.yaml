# Prometheus Helm Values - Metrics Collection
# Chart: prometheus-community/prometheus
# Repository: https://prometheus-community.github.io/helm-charts
# Version: 25.x

# Server configuration
server:
  enabled: true
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/prometheus/prometheus
    tag: "v2.48.1"
    pullPolicy: IfNotPresent
  replicaCount: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  persistentVolume:
    enabled: true
    size: 50Gi
    storageClass: longhorn
    accessModes:
      - ReadWriteOnce
  service:
    type: ClusterIP
    port: 9090
  ingress:
    enabled: true
    className: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      traefik.ingress.kubernetes.io/router.middlewares: automation-prometheus-forward-auth@kubernetescrd
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: prometheus.vectorweight.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: vectorweight-wildcard-tls
        hosts:
          - prometheus.vectorweight.com
  configMapReload:
    prometheus:
      enabled: true
  retention: "30d"
  global:
    scrape_interval: "15s"
    scrape_timeout: "10s"
    evaluation_interval: "15s"

# Alertmanager configuration
alertmanager:
  enabled: true
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/prometheus/alertmanager
    tag: "v0.26.0"
    pullPolicy: IfNotPresent
  replicaCount: 1
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: longhorn
    accessModes:
      - ReadWriteOnce
  service:
    type: ClusterIP
    port: 9093
  ingress:
    enabled: true
    className: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      traefik.ingress.kubernetes.io/router.middlewares: automation-prometheus-forward-auth@kubernetescrd
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: alertmanager.vectorweight.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: vectorweight-wildcard-tls
        hosts:
          - alertmanager.vectorweight.com

# Pushgateway configuration
pushgateway:
  enabled: true
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/prometheus/pushgateway
    tag: "v1.6.2"
    pullPolicy: IfNotPresent
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  service:
    type: ClusterIP
    port: 9091

# Node Exporter configuration
nodeExporter:
  enabled: true
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/prometheus/node-exporter
    tag: "v1.7.0"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Kube State Metrics configuration
kubeStateMetrics:
  enabled: true
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/kube-state-metrics/kube-state-metrics
    tag: "v2.10.0"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Service Monitor configuration
serviceMonitor:
  enabled: true
  namespace: monitoring
  interval: 30s
  scrapeTimeout: 10s

# Prometheus Rules
ruleFiles:
  - /etc/config/recording_rules.yml
  - /etc/config/alerting_rules.yml
  - /etc/config/rules
  - /etc/config/alerts

# Additional scrape configs
extraScrapeConfigs: |
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?
        replacement: :
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_name]
        action: replace
        target_label: container

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  fsGroup: 65534

# Pin all Prometheus components to homelab
nodeSelector:
  kubernetes.io/hostname: homelab

# Tolerations
tolerations: []

# Affinity
affinity: {}

# Grafana configuration (kube-prometheus-stack sub-chart)
grafana:
  adminPassword: ChangeMe123

  grafana.ini:
    server:
      root_url: https://grafana.vectorweight.com
    auth.generic_oauth:
      enabled: true
      name: Keycloak
      allow_sign_up: true
      client_id: grafana
      client_secret: ${GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET}
      scopes: openid email profile
      auth_url: https://auth.vectorweight.com/realms/vectorweight/protocol/openid-connect/auth
      token_url: https://auth.vectorweight.com/realms/vectorweight/protocol/openid-connect/token
      api_url: https://auth.vectorweight.com/realms/vectorweight/protocol/openid-connect/userinfo
      role_attribute_path: "contains(realm_access.roles[*], 'admin') && 'Admin' || 'Viewer'"
      signout_redirect_url: https://auth.vectorweight.com/realms/vectorweight/protocol/openid-connect/logout?post_logout_redirect_uri=https%3A%2F%2Fgrafana.vectorweight.com%2Flogin

  # Datasource provisioning
  additionalDataSources:
    - name: Loki
      type: loki
      uid: loki
      url: http://loki-gateway.monitoring.svc.cluster.local:80
      access: proxy
      isDefault: false
      jsonData:
        maxLines: 1000
        derivedFields:
          - name: TraceID
            matcherRegex: "(?:traceID|trace_id|traceId)[=:]\\s*(\\w+)"
            url: "$${__value.raw}"
            datasourceUid: tempo
            urlDisplayLabel: View Trace
    - name: Tempo
      type: tempo
      uid: tempo
      url: http://tempo.monitoring.svc.cluster.local:3100
      access: proxy
      isDefault: false
      jsonData:
        tracesToLogsV2:
          datasourceUid: loki
          filterByTraceID: true
          filterBySpanID: true
        tracesToMetrics:
          datasourceUid: prometheus
        nodeGraph:
          enabled: true
        serviceMap:
          datasourceUid: prometheus
        lokiSearch:
          datasourceUid: loki
    - name: OpenObserve
      type: elasticsearch
      uid: openobserve
      url: http://openobserve-openobserve-standalone.monitoring.svc.cluster.local:5080/api/default
      access: proxy
      isDefault: false
      basicAuth: true
      basicAuthUser: kang@vectorweight.com
      secureJsonData:
        basicAuthPassword: banana
      jsonData:
        esVersion: "7.10.0"
        timeField: "_timestamp"
        logMessageField: "log"
        logLevelField: "level"

  # Dashboard auto-provisioning via sidecar
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL
      folderAnnotation: grafana_folder
      provider:
        foldersFromFilesStructure: true

  # Ingress for Grafana
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
    hosts:
      - grafana.vectorweight.com
    tls:
      - secretName: vectorweight-wildcard-tls
        hosts:
          - grafana.vectorweight.com

  nodeSelector:
    kubernetes.io/hostname: homelab

  envFromSecret: grafana-oidc-secret
