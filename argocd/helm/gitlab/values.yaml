# GitLab Helm Values - Homelab Configuration
# Chart: gitlab/gitlab
# Repository: https://charts.gitlab.io/
# Version: 9.7.1 (GitLab 18.x - requires PostgreSQL 16+)

# Skip upgrade check for fresh installs
upgradeCheck:
  enabled: false

global:
  edition: ce
  hosts:
    domain: vectorweight.com
    https: true
    externalIP: ""
    gitlab:
      name: git.vectorweight.com
    registry:
      name: registry.vectorweight.com
    minio:
      name: minio.vectorweight.com
    smartcard:
      name: smartcard.vectorweight.com
  ingress:
    configureCertmanager: false
    class: traefik
    tls:
      enabled: true
      secretName: vectorweight-wildcard-tls
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
  # External PostgreSQL connection (bundled PostgreSQL disabled below)
  # Service name: gitlab-postgresql (from Bitnami PostgreSQL chart release)
  psql:
    host: gitlab-postgresql
    port: 5432
    username: gitlab
    database: gitlabhq_production
    password:
      secret: gitlab-postgresql
      key: password
  # External Redis connection (bundled Redis disabled below)
  # Service name: gitlab-redis-master (from Bitnami Redis chart release)
  redis:
    host: gitlab-redis-master
    port: 6379
    auth:
      enabled: true
      secret: gitlab-redis
      key: redis-password
  # Enable repository mirroring feature
  appConfig:
    repositoryMirroring:
      enabled: true
      # Sync interval for pull mirrors (every 6 hours)
      capacityPerWorker: 10
    # Import sources - enable GitHub import
    importSources:
      - github
      - gitlab
      - bitbucket
    # Enable external authorization for mirrors
    externalAuthorization:
      enabled: false
    # Keycloak SSO via OmniAuth OpenID Connect
    omniauth:
      enabled: true
      allowSingleSignOn:
        - openid_connect
      autoSignInWithProvider: "openid_connect"
      blockAutoCreatedUsers: false
      providers:
        - secret: gitlab-oidc-provider
          key: provider

# GitLab Rails (main application)
# NOTE: Kubernetes injects GITLAB_PORT=tcp://... as a service env var,
# which collides with GitLab's expected port number. extraEnv overrides this.
gitlab:
  migrations:
    extraEnv:
      GITLAB_PORT: "443"
  webservice:
    extraEnv:
      GITLAB_PORT: "443"
    minReplicas: 1
    maxReplicas: 3
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2
        memory: 4Gi
    hpa:
      targetAverageUtilization: 70

  sidekiq:
    extraEnv:
      GITLAB_PORT: "443"
    minReplicas: 1
    maxReplicas: 2
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        cpu: 1
        memory: 2Gi

  toolbox:
    extraEnv:
      GITLAB_PORT: "443"

  gitlab-exporter:
    extraEnv:
      GITLAB_PORT: "443"

# PostgreSQL - Disable bundled PostgreSQL (using external psql defined in global)
# GitLab chart 9.7.1 defaults to bitnamilegacy/postgresql:16.6.0 which doesn't exist
postgresql:
  install: false

# Redis - Disable bundled Redis (using external redis defined in global)
# GitLab chart 9.7.1 defaults to bitnami/redis:7.4 which doesn't exist
redis:
  install: false

# Gitaly (Git repository storage)
gitaly:
  persistence:
    enabled: true
    size: 50Gi
    storageClass: longhorn-homelab
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi

# MinIO (Object storage)
minio:
  persistence:
    enabled: true
    size: 5Gi
    storageClass: longhorn-homelab
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# Registry (Docker registry)
registry:
  storage:
    secret: gitlab-registry-storage
    key: config
  persistence:
    enabled: true
    size: 5Gi
    storageClass: longhorn-homelab
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  # Registry database metadata (uses main PostgreSQL 16 instance)
  database:
    enabled: true

# GitLab Runner - DISABLED in bundled chart
# The bundled runner uses legacy registration tokens which don't work with
# fresh databases (GitLab 15.6+ requires authentication tokens from the UI).
# Use the separate gitlab-runners ArgoCD app instead, which can be configured
# with a proper authentication token after GitLab is running.
gitlab-runner:
  install: false
  # Trust internal CA certificate
  certsSecretName: gitlab-runner-certs
  runners:
    privileged: true
    cache:
      cacheType: s3
      s3ServerAddress: minio.homelab.local:9000
      s3BucketName: gitlab-runner-cache
      s3CacheInsecure: true
    builds:
      cpuLimit: "2"
      memoryLimit: "4Gi"
      cpuRequests: "500m"
      memoryRequests: "1Gi"
    helpers:
      cpuLimit: "500m"
      memoryLimit: "512Mi"
      cpuRequests: "100m"
      memoryRequests: "128Mi"
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Shared secrets
sharedSecrets:
  enabled: true

# Service accounts
serviceAccount:
  enabled: true
  create: true

# Network policies
networkPolicy:
  enabled: true

# Disable bundled nginx-ingress (using Traefik instead)
nginx-ingress:
  enabled: false

# Prometheus monitoring
prometheus:
  install: false  # Using external Prometheus

# cert-manager - disable bundled (using cluster-wide cert-manager)
# The gitlab chart uses 'condition: installCertmanager' (top-level)
installCertmanager: false

# Grafana monitoring
grafana:
  install: false  # Using external Grafana

# Initial root password (will be overridden by sealed secrets)
initialRootPassword:
  secret: gitlab-initial-root-password

# SMTP configuration (optional)
smtp:
  enabled: false

# LDAP configuration (optional)
ldap:
  enabled: false

# OAuth configuration
oauth:
  enabled: true

# Backup configuration
backup:
  cron:
    enabled: true
    schedule: "0 2 * * *"
    concurrencyPolicy: Replace
    failedJobsHistoryLimit: 1
    successfulJobsHistoryLimit: 3
    job:
      annotations:
        backup.velero.io/backup-volumes: ""
  persistence:
    enabled: true
    size: 10Gi
    storageClass: longhorn-homelab

# Resource limits
resources:
  requests:
    cpu: 2
    memory: 8Gi
  limits:
    cpu: 4
    memory: 16Gi

# Pin all GitLab components to homelab
nodeSelector:
  kubernetes.io/hostname: homelab

# Tolerations
tolerations: []

# Affinity
affinity: {}
