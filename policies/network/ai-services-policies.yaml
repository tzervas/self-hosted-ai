# Default Deny NetworkPolicy for ai-services namespace
# All ingress and egress is blocked except explicitly allowed
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: ai-services
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow DNS egress for all pods in ai-services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: ai-services
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Allow LAN ingress to services with lan-accessible label
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-lan-ingress
  namespace: ai-services
spec:
  podSelector:
    matchLabels:
      network.policy/lan-accessible: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - ipBlock:
            cidr: 192.168.0.0/16
---
# Allow ingress from Traefik for exposed services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-traefik-ingress
  namespace: ai-services
spec:
  podSelector:
    matchLabels:
      network.policy/traefik-ingress: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: traefik
          podSelector:
            matchLabels:
              app.kubernetes.io/name: traefik
---
# Allow Traefik ingress to cert-manager ACME HTTP-01 solver pods
# These pods are created dynamically by cert-manager and cannot have custom labels
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-acme-solver-ingress
  namespace: ai-services
spec:
  podSelector:
    matchLabels:
      acme.cert-manager.io/http01-solver: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: traefik
          podSelector:
            matchLabels:
              app.kubernetes.io/name: traefik
---
# Allow inter-namespace communication for AI services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ai-services-internal
  namespace: ai-services
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ai-services
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ai-services
---
# Allow Ollama to pull models from registry.ollama.ai (HTTPS egress)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ollama-registry-egress
  namespace: ai-services
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: ollama
  policyTypes:
    - Egress
  egress:
    - ports:
        - protocol: TCP
          port: 443
---
# Allow egress to gpu-workloads namespace (Ollama GPU, ComfyUI, audio, video)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gpu-workloads-egress
  namespace: ai-services
spec:
  podSelector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values:
          - litellm
          - open-webui
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: gpu-workloads
      ports:
        - protocol: TCP
          port: 11434  # Ollama GPU
        - protocol: TCP
          port: 8188   # ComfyUI
        - protocol: TCP
          port: 5004   # Audio server
        - protocol: TCP
          port: 5005   # Video server
