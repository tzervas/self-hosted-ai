# SearXNG Integration for Self-Hosted AI Stack
# Provides metasearch capabilities for RAG and research workflows
# Version: 2026.1.11

services:
  searxng:
    image: searxng/searxng:2026.1.11-cf74e1d9e
    container_name: searxng-server
    ports:
      - "${SEARXNG_PORT:-8080}:8080"
    volumes:
      - ${DATA_PATH:-/data}/searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://${SERVER_HOST:-192.168.1.170}:${SEARXNG_PORT:-8080}
      - SEARXNG_SECRET_KEY=${SEARXNG_SECRET_KEY:-change-me-to-a-secure-random-string}
      # Enable JSON output for API integration
      - SEARXNG_SETTINGS_SEARCH__FORMAT=json
      # Default to safe search
      - SEARXNG_SETTINGS_SEARCH__SAFE_SEARCH=1
      # Enable autocomplete
      - SEARXNG_SETTINGS_SEARCH__AUTOCOMPLETE=google
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - search
      - full
      - research

  # Redis for SearXNG rate limiting and caching
  searxng-redis:
    image: redis:8.4.0-alpine
    container_name: searxng-redis
    command: redis-server --save "" --appendonly no
    tmpfs:
      - /data
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    restart: unless-stopped
    profiles:
      - search
      - full
      - research

networks:
  default:
    name: self-hosted-ai
    external: true
