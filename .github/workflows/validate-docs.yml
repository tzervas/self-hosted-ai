name: Validate Documentation

on:
  pull_request:
    paths:
      - '**.md'
      - 'docs/**'
      - 'scripts/validate_docs_index.py'
      - 'scripts/generate_index_json.py'
      - 'scripts/update_index_tokens.py'
  push:
    branches:
      - main
      - dev
    paths:
      - '**.md'
      - 'docs/**'

jobs:
  validate:
    name: Validate Documentation Index
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate INDEX.md links
        run: |
          python3 scripts/validate_docs_index.py

      - name: Check token counts
        run: |
          python3 scripts/update_index_tokens.py

      - name: Validate INDEX.json generation
        run: |
          python3 scripts/generate_index_json.py
          # Check if INDEX.json is valid JSON
          python3 -c "import json; json.load(open('docs/INDEX.json'))"

      - name: Check for uncommitted INDEX changes
        run: |
          # If INDEX.md changed, INDEX.json should also be updated
          if git diff --name-only | grep -q 'docs/INDEX.md'; then
            if ! git diff --name-only | grep -q 'docs/INDEX.json'; then
              echo "‚ùå INDEX.md changed but INDEX.json not regenerated!"
              echo "Run: python3 scripts/generate_index_json.py"
              exit 1
            fi
          fi

  linkcheck:
    name: Check External Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: Check links in documentation
        run: |
          # Check all markdown files except archived docs
          find . -name "*.md" \
            ! -path "./docs/archive/*" \
            ! -path "**/node_modules/*" \
            ! -path "**/.venv/*" \
            -exec markdown-link-check --quiet --config .markdown-link-check.json {} \;
        continue-on-error: true  # Don't fail on external link issues

  metrics:
    name: Documentation Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Calculate documentation metrics
        run: |
          echo "üìä Documentation Metrics"
          echo
          echo "File Counts:"
          echo "  Total markdown files: $(find . -name '*.md' | wc -l)"
          echo "  Indexed documents: $(python3 -c 'import json; data=json.load(open(\"docs/INDEX.json\")); print(data[\"statistics\"][\"documents_indexed\"])')"
          echo "  Coverage: $(python3 -c 'import json; data=json.load(open(\"docs/INDEX.json\")); print(f\"{data[\"statistics\"][\"index_coverage\"]*100:.1f}%\")')"
          echo
          echo "Token Counts:"
          echo "  Total documentation: $(python3 -c 'import json; data=json.load(open(\"docs/INDEX.json\")); print(f\"{data[\"statistics\"][\"total_actual_tokens\"]:,}\")')"
          echo "  INDEX.md size: $(python3 -c 'words=len(open(\"docs/INDEX.md\").read().split()); print(f\"{int(words*1.3):,}\")')"
          echo "  Token reduction: $(python3 -c 'import json; data=json.load(open(\"docs/INDEX.json\")); idx_words=len(open(\"docs/INDEX.md\").read().split()); idx_tokens=int(idx_words*1.3); total=data[\"statistics\"][\"total_actual_tokens\"]; print(f\"{(1-idx_tokens/total)*100:.1f}%\")')"
