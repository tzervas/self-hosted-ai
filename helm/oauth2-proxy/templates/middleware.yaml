# Shared ForwardAuth middleware for all services behind oauth2-proxy.
# Each service gets its own named middleware so Traefik can route correctly.
# All point to the same oauth2-proxy instance.
{{- $proxyAddress := printf "http://oauth2-proxy.%s.svc.cluster.local:%d/oauth2/auth" .Release.Namespace (int .Values.service.port) }}

{{- range .Values.protectedServices }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: {{ .name }}-forward-auth
spec:
  forwardAuth:
    address: {{ $proxyAddress }}
    trustForwardHeader: true
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Access-Token
      - Authorization
{{- end }}
