replicaCount: 1

image:
  repository: ghcr.io/open-webui/open-webui
  tag: v0.8.3
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8080

ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    cert-manager.io/cluster-issuer: letsencrypt-production
  hosts:
    - host: ai.vectorweight.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - ai.vectorweight.com
      secretName: vectorweight-wildcard-tls

# Environment configuration
env:
  OLLAMA_BASE_URLS: "http://ollama-gpu.gpu-workloads:11434;http://ollama.ai-services:11434"
  WEBUI_NAME: "Self-Hosted AI Server"
  WEBUI_ADMIN_NAME: "kang"
  # CRITICAL: Force env vars to override database
  ENABLE_PERSISTENT_CONFIG: "False"
  ENABLE_AUTH: "true"
  ENABLE_SIGNUP: "false"
  # ========================================
  # Model Defaults
  # ========================================
  # Default model for new chats (GPU-first)
  DEFAULT_MODELS: "qwen2.5-coder:14b"
  # Internal task models (lightweight for background tasks)
  TASK_MODEL: "llama3.1:8b"
  TITLE_GENERATION_PROMPT_TEMPLATE: "Create a concise, 3-5 word title for this chat. No quotes or punctuation. Title:"
  # ========================================
  # Tools & Function Calling
  # ========================================
  # Enable native tool/function calling for compatible models
  TOOLS_FUNCTION_CALLING_PROMPT_TEMPLATE: "Available Tools: {{TOOLS}}\nIf a tool is needed, respond with the JSON tool call. Otherwise respond normally."
  # ========================================
  # RAG & Document Processing
  # ========================================
  RAG_EMBEDDING_ENGINE: "ollama"
  RAG_EMBEDDING_MODEL: "nomic-embed-text:latest"
  RAG_EMBEDDING_OLLAMA_URL: "http://ollama.ai-services:11434"
  # Chunk size tuned for technical documentation (code + prose)
  CHUNK_SIZE: "1000"
  CHUNK_OVERLAP: "200"
  RAG_TOP_K: "5"
  RAG_RELEVANCE_THRESHOLD: "0.3"
  PDF_EXTRACT_IMAGES: "true"
  # Web content fetching (fetch URLs pasted in chat)
  ENABLE_RAG_LOCAL_WEB_FETCH: "true"
  # ========================================
  # Web Search (SearXNG)
  # ========================================
  ENABLE_RAG_WEB_SEARCH: "true"
  RAG_WEB_SEARCH_ENGINE: "searxng"
  SEARXNG_QUERY_URL: "http://searxng:8080/search?q=<query>"
  RAG_WEB_SEARCH_RESULT_COUNT: "5"
  RAG_WEB_SEARCH_CONCURRENT_REQUESTS: "3"
  # ========================================
  # Evaluation Arena (A/B model comparison)
  # ========================================
  ENABLE_EVALUATION_ARENA_MODELS: "true"
  EVALUATION_ARENA_MODELS: "qwen2.5-coder:14b,phi4:latest,llama3.1:8b,mistral:7b"
  # ========================================
  # Image Generation
  # ========================================
  ENABLE_IMAGE_GENERATION: "true"
  IMAGE_GENERATION_ENGINE: "comfyui"
  COMFYUI_BASE_URL: "http://comfyui-self-hosted-ai-gpu-worker-comfyui.gpu-workloads:8188"
  IMAGE_SIZE: "1024x1024"
  IMAGE_STEPS: "30"
  # ComfyUI SDXL workflow (API format) - node IDs map to Open WebUI controls
  COMFYUI_WORKFLOW: '{"3":{"inputs":{"seed":0,"steps":25,"cfg":7.5,"sampler_name":"euler_ancestral","scheduler":"normal","denoise":1,"model":["4",0],"positive":["6",0],"negative":["7",0],"latent_image":["5",0]},"class_type":"KSampler"},"4":{"inputs":{"ckpt_name":"sd_xl_base_1.0.safetensors"},"class_type":"CheckpointLoaderSimple"},"5":{"inputs":{"width":1024,"height":1024,"batch_size":1},"class_type":"EmptyLatentImage"},"6":{"inputs":{"text":"Prompt","clip":["4",1]},"class_type":"CLIPTextEncode"},"7":{"inputs":{"text":"blurry, bad quality, distorted, ugly, deformed","clip":["4",1]},"class_type":"CLIPTextEncode"},"8":{"inputs":{"samples":["3",0],"vae":["4",2]},"class_type":"VAEDecode"},"9":{"inputs":{"filename_prefix":"OpenWebUI","images":["8",0]},"class_type":"SaveImage"}}'
  # Node ID mapping: prompt→6, negative→7, seed/steps/cfg→3, width/height→5
  COMFYUI_WORKFLOW_NODES: '{"positive_prompt":{"node_id":"6","field":"text"},"negative_prompt":{"node_id":"7","field":"text"},"seed":{"node_id":"3","field":"seed"},"steps":{"node_id":"3","field":"steps"},"cfg":{"node_id":"3","field":"cfg"},"width":{"node_id":"5","field":"width"},"height":{"node_id":"5","field":"height"}}'
  # ========================================
  # Community & Sharing
  # ========================================
  ENABLE_COMMUNITY_SHARING: "false"
  # ========================================
  # Keycloak OIDC Configuration
  # ========================================
  WEBUI_URL: "https://ai.vectorweight.com"
  ENABLE_OAUTH_SIGNUP: "true"
  OAUTH_PROVIDER_NAME: "Keycloak"
  OPENID_PROVIDER_URL: "http://keycloak.auth.svc.cluster.local:8080/realms/vectorweight/.well-known/openid-configuration"
  OAUTH_SCOPES: "openid profile email"
  OAUTH_USERNAME_CLAIM: "preferred_username"
  OAUTH_EMAIL_CLAIM: "email"
  # Allow both OAuth and local login
  ENABLE_LOGIN_FORM: "true"
  # Merge accounts by email (existing admin stays admin)
  OAUTH_MERGE_ACCOUNTS_BY_EMAIL: "true"
  # Auto-approve new SSO users (no admin approval needed)
  DEFAULT_USER_ROLE: "user"
  # ========================================
  # OpenTelemetry Configuration
  # ========================================
  # Enable OpenTelemetry auto-instrumentation for Python
  OTEL_PYTHON_DISABLED_INSTRUMENTATIONS: ""
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector.monitoring.svc.cluster.local:4318"
  OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
  OTEL_SERVICE_NAME: "open-webui"
  OTEL_RESOURCE_ATTRIBUTES: "service.namespace=ai-services,deployment.environment=production"
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "otlp"
  OTEL_LOGS_EXPORTER: "none"
  # Instrument FastAPI, HTTP requests, and database calls
  OTEL_PYTHON_FASTAPI_EXCLUDED_URLS: "/health"
  OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"

# Secret references
secretEnv:
  WEBUI_SECRET_KEY:
    secretName: webui-secret
    key: secret-key
  WEBUI_ADMIN_EMAIL:
    secretName: webui-secret
    key: admin-email
  WEBUI_ADMIN_PASSWORD:
    secretName: webui-secret
    key: admin-password
  # Keycloak OIDC credentials (from sealed secret)
  OAUTH_CLIENT_ID:
    secretName: keycloak-oidc-secret
    key: client-id
  OAUTH_CLIENT_SECRET:
    secretName: keycloak-oidc-secret
    key: client-secret

persistence:
  enabled: true
  size: 2Gi
  storageClass: "longhorn"
  accessMode: ReadWriteOnce

resources:
  requests:
    cpu: 250m
    memory: 768Mi  # v0.7.2 uses ~640MB RSS; 768Mi keeps HPA utilization ~83%
  limits:
    cpu: 2000m
    memory: 4Gi

# Health probes for deployment orchestration
probes:
  # Startup probe - allows slow container startup before liveness kicks in
  startup:
    enabled: true
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30  # 30 * 10s = 5 min max startup time
    successThreshold: 1
  # Liveness probe - restart container if unhealthy
  liveness:
    enabled: true
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
    successThreshold: 1
  # Readiness probe - remove from service if not ready
  readiness:
    enabled: true
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

# Horizontal Pod Autoscaler - scale based on CPU/memory
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 1  # Capped at 1: PVC is RWO, Multi-Attach errors with >1 replica
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 90  # Raised from 80% to avoid scaling storm
  scaleDownStabilizationWindowSeconds: 300
  scaleUpStabilizationWindowSeconds: 0

# Vertical Pod Autoscaler - recommend optimal resources
# NOTE: Requires VPA CRD to be installed (not installed in this cluster)
vpa:
  enabled: false
  updateMode: "Off"  # "Off" = recommendations only, "Auto" = automatic updates
  minAllowed:
    cpu: 100m
    memory: 256Mi
  maxAllowed:
    cpu: 4
    memory: 8Gi

# Security context for rootless execution
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  fsGroupChangePolicy: "OnRootMismatch"

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false

podLabels:
  network.policy/traefik-ingress: "true"

nodeSelector:
  kubernetes.io/hostname: homelab
tolerations: []
affinity: {}
