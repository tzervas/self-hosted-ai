# Loki configuration
loki:
  enabled: true
  deploymentMode: SingleBinary

  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: 'filesystem'

    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

  singleBinary:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    persistence:
      enabled: true
      size: 10Gi
      storageClass: longhorn

  # Disable components not needed for single binary mode
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0

  # Configure gateway (for Grafana integration)
  gateway:
    enabled: true
    replicas: 1
    service:
      type: ClusterIP
      port: 80

  # Monitoring
  monitoring:
    lokiCanary:
      enabled: false
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false

# Promtail configuration (DaemonSet on all nodes)
promtail:
  enabled: true

  config:
    clients:
      - url: http://{{ .Release.Name }}-loki-gateway/loki/api/v1/push

    positions:
      filename: /tmp/positions.yaml

    scrape_configs:
      # Kubernetes pods
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node_name
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Deploy on all nodes
  tolerations:
    - operator: Exists
      effect: NoSchedule
